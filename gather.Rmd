---
title: "Gathering Data"
author: "Westley Cook"
date: "2/27/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)
library(rvest)

```

MLB data downloaded as zip file from http://www.seanlahman.com/baseball-archive/statistics/

```{r mlb, include=FALSE}

mlb_salaries <- read_csv("raw-data/mlb/salaries.csv") %>% 
  clean_names()

# NEED TO FIX NAMES FOR 'ghome' 'team_i_dlahman45' AND 'team_i_dretro'
mlb_teams <- read_csv("raw-data/mlb/teams.csv") %>% 
  clean_names()

glimpse(mlb_salaries)
glimpse(mlb_teams)

mlb_teams %>% 
  arrange(desc(ws_win))

# Exploring Data initially:

# Data is from here: http://www.seanlahman.com/baseball-archive/statistics/

# Somebody who did something similar to me:
# https://courses.cs.washington.edu/courses/cse140/13wi/projects/mirae-report.pdf

summary(mlb_salaries)

by_team_and_year <- mlb_salaries %>% 
  group_by(team_id, year_id) %>% 
  summarize(payroll = sum(salary,
                          na.rm = TRUE))

by_team_and_year %>%   
   ggplot(aes(year_id,
             payroll)) +
  geom_line() +
  facet_wrap(~ team_id)

# Will want to adjust all dollar values for inflation

# Could look into big/sudden changes in team spending (e.g. LAN in ~2010) to see
# if the money had an impact

# Will want to see if I can find data on total wins for the applicable time
# window, not just on division or league or WS wins

# Money spent is independent variable and wins/success is dependent variable;
# trying to find out if money itself drives success, or if they tend to
# fluctuate together (e.g. because teams that do well sell more tickets and get
# more revenue and can then spend more to keep doing well)

# Can scrape https://hoopshype.com/salaries/ for NBA data from 90/91 - 2019/20

# Or, alternatively, can try downloading dataframes from 
# https://data.world/datadavis/nba-salaries

# Could also try scraping NHL data from \
# https://en.wikipedia.org/wiki/List_of_team_payrolls_in_the_NHL
# (small sample size though)


```

NBA data downloaded as zip file from https://data.world/datadavis/nba-salaries

```{r nba, include=FALSE}

nba_players <- read_csv("raw-data/nba/players.csv") %>% 
  clean_names()

nba_salaries <- read_csv("raw-data/nba/salaries_1985to2018.csv") %>% 
  clean_names()

glimpse(nba_players) # looks not very useful for my purposes...

glimpse(nba_salaries) # goes from 1984-85 to 2017-18

team_salaries_by_season <- nba_salaries %>% 
  group_by(team, season) %>% 
  summarize(team_salary = sum(salary))

team_salaries_by_season %>% 
  arrange(season)

team_salaries_by_season %>% 
  ggplot(aes(as.factor(season), team_salary)) +
  facet_wrap(~team) +
  geom_point()

# Found data on wins and postseason success!

hawks <- read_html(
    "https://www.landofbasketball.com/teams/records_atlanta_hawks.htm") %>% 
  html_nodes("table") %>% 
  .[2] %>% 
  html_table() %>% 
  as.data.frame() %>% 
  slice(2, 5:38) %>% 
  row_to_names(1) %>% 
  clean_names() %>% 
  rename(conference = standing_2) %>% 
  rename(rs_win_pct = percent) %>% 
  rename(playoff_win_pct = percent_2) %>% 
  separate(w_l, into = c("wins", "losses"), sep = "-") %>% 
  separate(w_l_2, into = c("playoff_wins", "playoff_losses"), sep = "-") %>% 
  mutate(lockout = ifelse(season %>% endsWith(" *"), TRUE, FALSE)) %>% 
  mutate(season = ifelse(season %>% endsWith(" *"), 
                         season %>% substr(start = 1, stop = 7),
                         season)) %>% 

# pattern from here: http://stla.github.io/stlapblog/posts/Numextract.html  
    
  mutate(standing = standing %>% str_extract("\\-*\\d+\\.*\\d*")) %>% 
  rename(conf_standing = standing) %>% 
  mutate(wins = as.numeric(wins),
         losses = as.numeric(losses),
         rs_win_pct = as.numeric(rs_win_pct),
         conf_standing = as.numeric(conf_standing),
         playoff_wins = as.numeric(playoff_wins),
         playoff_losses = as.numeric(playoff_losses),
         playoff_win_pct = as.numeric(playoff_win_pct))

team_season_data <- function(team_url){
  read_html(team_url) %>% 
  html_nodes("table") %>% 
  .[2] %>% 
  html_table() %>% 
  as.data.frame() %>% 
  slice(2, 5:38) %>% 
  row_to_names(1) %>% 
  clean_names() %>% 
  rename(conference = standing_2) %>% 
  rename(rs_win_pct = percent) %>% 
  rename(playoff_win_pct = percent_2) %>% 
  separate(w_l, into = c("wins", "losses"), sep = "-") %>% 
  separate(w_l_2, into = c("playoff_wins", "playoff_losses"), sep = "-") %>% 
  mutate(lockout = ifelse(season %>% endsWith(" *"), TRUE, FALSE)) %>% 
  mutate(season = ifelse(season %>% endsWith(" *"), 
                         season %>% substr(start = 1, stop = 7),
                         season)) %>% 
  mutate(standing = standing %>% str_extract("\\-*\\d+\\.*\\d*")) %>% 
  rename(conf_standing = standing) %>% 
  mutate(wins = as.numeric(wins),
         losses = as.numeric(losses),
         rs_win_pct = as.numeric(rs_win_pct),
         conf_standing = as.numeric(conf_standing),
         playoff_wins = as.numeric(playoff_wins),
         playoff_losses = as.numeric(playoff_losses),
         playoff_win_pct = as.numeric(playoff_win_pct))
}

celtics <- team_season_data(
  "https://www.landofbasketball.com/teams/records_boston_celtics.htm")

nets <- team_season_data(
  "https://www.landofbasketball.com/teams/records_brooklyn_nets.htm"
)

# hornets only have 28 rows; started in 1988-89, missiong 2002-03 and 2003-04

hornets <- team_season_data(
  "https://www.landofbasketball.com/teams/records_charlotte_hornets.htm"
)

bulls <- team_season_data(
  "https://www.landofbasketball.com/teams/records_chicago_bulls.htm"
)

cavs <- team_season_data(
  "https://www.landofbasketball.com/teams/records_cleveland_cavaliers.htm"
)

mavs <- team_season_data(
  "https://www.landofbasketball.com/teams/records_dallas_mavericks.htm"
)

nuggets <- team_season_data(
  "https://www.landofbasketball.com/teams/records_denver_nuggets.htm"
)

pistons <- team_season_data(
  "https://www.landofbasketball.com/teams/records_detroit_pistons.htm"
)

warriors <- team_season_data(
  "https://www.landofbasketball.com/teams/records_golden_state_warriors.htm"
)

rockets <- team_season_data(
  "https://www.landofbasketball.com/teams/records_houston_rockets.htm"
)

pacers <- team_season_data(
  "https://www.landofbasketball.com/teams/records_indiana_pacers.htm"
)

clippers <- team_season_data(
  "https://www.landofbasketball.com/teams/records_los_angeles_clippers.htm"
)

lakers <- team_season_data(
  "https://www.landofbasketball.com/teams/records_los_angeles_lakers.htm"
)

# grizzlies only have 23 rows; started in 1995-96

grizzlies <- team_season_data(
  "https://www.landofbasketball.com/teams/records_memphis_grizzlies.htm"
)

# heat only have 30 rows; started in 1988-89

heat <- team_season_data(
  "https://www.landofbasketball.com/teams/records_miami_heat.htm"
)

bucks <- team_season_data(
  "https://www.landofbasketball.com/teams/records_milwaukee_bucks.htm"
)

# twolves only have 29 rows; started in 1989-90

twolves <- team_season_data(
  "https://www.landofbasketball.com/teams/records_minnesota_timberwolves.htm"
)

# pelicans only have 16 rows; started in 2002-03

pelicans <- team_season_data(
  "https://www.landofbasketball.com/teams/records_new_orleans_pelicans.htm"
)

knicks <- team_season_data(
  "https://www.landofbasketball.com/teams/records_new_york_knicks.htm"
)

thunder <- team_season_data(
  "https://www.landofbasketball.com/teams/records_oklahoma_city_thunder.htm"
)

# magic only have 29 rows; started in 1989-90

magic <- team_season_data(
  "https://www.landofbasketball.com/teams/records_orlando_magic.htm"
)

p76ers <- team_season_data(
  "https://www.landofbasketball.com/teams/records_philadelphia_76ers.htm"
)

suns <- team_season_data(
  "https://www.landofbasketball.com/teams/records_phoenix_suns.htm"
)

blazers <- team_season_data(
  "https://www.landofbasketball.com/teams/records_portland_trailblazers.htm"
)

kings <- team_season_data(
  "https://www.landofbasketball.com/teams/records_sacramento_kings.htm"
)

spurs <- team_season_data(
  "https://www.landofbasketball.com/teams/records_san_antonio_spurs.htm"
)

# raptors only have 23 rows; started in 1995-96

raptors <- team_season_data(
  "https://www.landofbasketball.com/teams/records_toronto_raptors.htm"
)

jazz <- team_season_data(
  "https://www.landofbasketball.com/teams/records_utah_jazz.htm"
)

wizards <- team_season_data(
  "https://www.landofbasketball.com/teams/records_washington_wizards.htm"
)

```

Could scrape NHL data from here if so inclined:
https://en.wikipedia.org/wiki/List_of_team_payrolls_in_the_NHL
