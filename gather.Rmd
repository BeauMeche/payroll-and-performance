---
title: "Gathering Data"
author: "Westley Cook"
date: "2/27/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)
library(rvest)
library(stringr)
library(magrittr)
library(gridExtra)

```

MLB data downloaded as zip file from http://www.seanlahman.com/baseball-archive/statistics/

```{r load-mlb-data, include=FALSE}

mlb_salaries_raw <- read_csv("raw-data/mlb/salaries.csv") %>% 
  clean_names()

# NEED TO FIX NAMES FOR 'ghome' 'team_i_dlahman45' AND 'team_i_dretro'
mlb_teams <- read_csv("raw-data/mlb/teams.csv") %>% 
  clean_names()

# Exploring Data initially:

# Data is from here: http://www.seanlahman.com/baseball-archive/statistics/

# Somebody who did something similar to me:
# https://courses.cs.washington.edu/courses/cse140/13wi/projects/mirae-report.pdf

mlb_salaries <- mlb_salaries_raw %>% 
  group_by(team_id, year_id) %>% 
  summarize(payroll = sum(salary,
                          na.rm = TRUE))

mlb_salaries %>% 
  ggplot(aes(year_id, payroll)) +
  geom_point() +
  facet_wrap(~team_id)



mlb_teams_salaries <- mlb_salaries %>% 
  right_join(mlb_teams, by = c("year_id", "team_id")) %>% 
  filter(year_id > 1984)



# Will want to adjust all dollar values for inflation

# Could look into big/sudden changes in team spending (e.g. LAN in ~2010) to see
# if the money had an impact

# Will want to see if I can find data on total wins for the applicable time
# window, not just on division or league or WS wins

mlb_rs_wins <- read_html("https://www.baseball-reference.com/leagues/MLB/") %>% 
  html_nodes("table") %>% 
  html_table() %>% 
  as.data.frame() %>% 
  na_if("") %>% 
  filter(G != "G")

mlb_rs_wins %<>% 
  pivot_longer(cols = ARI:WSN,
               names_to = "franch_id", 
               values_to = "rs_wins",
               values_drop_na = TRUE) %>% 
  rename(games_played = G,
         year = Year) %>% 
  mutate(year = as.numeric(year),
         games_played = as.numeric(games_played),
         rs_wins = as.numeric(rs_wins),
         franch_id = gsub("LAA", "ANA", franch_id),
         franch_id = gsub("MIA", "FLA", franch_id),
         franch_id = gsub("TBR", "TBD", franch_id))

```

```{r join-mlb-data, echo=FALSE}

# team IDs to change to make this work:
# LAA (should be ANA), MIA (should be FLA), TBR (should be TBD)

mlb_full <- mlb_rs_wins %>% 
  left_join(mlb_teams_salaries, by = c("franch_id", 
                                       "year" = "year_id")) %>% 
  filter(year <= 2016,
         year >= 1985) %>% 
  mutate(rs_win_pct = rs_wins / games_played,
         div_win = ifelse(rank == 1,
                          "Y",
                          "N")) %>% 
  select(year, franch_id, team_id, name, payroll,
         games_played, rs_wins, rs_win_pct,
         lg_id, rank, div_win, lg_win, ws_win)

# in the above, rank appears to mean within the division; I could add my own
# variable to show whether a team made the playoffs, but it would have to
# somehow add the wild card teams - could figure out how to group by year and
# league and take the top four teams, but that might leave out division
# champs... This is a complicated manipulation :/ Might be easier just to take
# division champs

```

```{r plot-mlb-data, echo=FALSE}

mlb_full %>% 
  ggplot(aes(payroll / 1000000, 
             round(rs_win_pct, digits = 2))) +
  geom_point() +
  facet_wrap(~year, scales = "free_x") +
  labs(title = "MLB Team Payroll and Regular Season Win Percentage",
       subtitle = "See a positive correlation emerging over time",
       x = "Payroll (millions)",
       y = "Regular Season Win Percentage") +
  theme_classic() +
  scale_x_continuous(breaks = c(0, 100, 200)) +
  geom_smooth(method = "lm", se = FALSE)

ggsave("mlb_payroll_winpct_plot.png")

```

NBA data downloaded as zip file from https://data.world/datadavis/nba-salaries

```{r load-nba-data, include=FALSE}

nba_players <- read_csv("raw-data/nba/players.csv") %>% 
  clean_names()   # not that useful

nba_salaries_raw <- read_csv("raw-data/nba/salaries_1985to2018.csv") %>% 
  clean_names()   # goes from 1984-85 to 2017-18

nba_salaries <- nba_salaries_raw %>% 
  group_by(team, season) %>% 
  summarize(team_salary = sum(salary))

nba_salaries %>% 
  ggplot(aes(as.factor(season), team_salary)) +
  facet_wrap(~team) +
  geom_point()

# Found data on wins and postseason success!

hawks <- read_html(
    "https://www.landofbasketball.com/teams/records_atlanta_hawks.htm") %>% 
  html_nodes("table") %>% 
  .[2] %>% 
  html_table() %>% 
  as.data.frame() %>% 
  slice(2, 5:38) %>% 
  row_to_names(1) %>% 
  clean_names() %>% 
  rename(conference = standing_2) %>% 
  rename(rs_win_pct = percent) %>% 
  rename(playoff_win_pct = percent_2) %>% 
  separate(w_l, into = c("wins", "losses"), sep = "-") %>% 
  separate(w_l_2, into = c("playoff_wins", "playoff_losses"), sep = "-") %>% 
  mutate(lockout = ifelse(season %>% endsWith(" *"), TRUE, FALSE)) %>% 
  mutate(season = ifelse(season %>% endsWith(" *"), 
                         season %>% substr(start = 1, stop = 7),
                         season)) %>% 

# pattern from here: http://stla.github.io/stlapblog/posts/Numextract.html  
    
  mutate(standing = standing %>% str_extract("\\-*\\d+\\.*\\d*")) %>% 
  rename(conf_standing = standing) %>% 
  mutate(wins = as.numeric(wins),
         losses = as.numeric(losses),
         rs_win_pct = as.numeric(rs_win_pct),
         conf_standing = as.numeric(conf_standing),
         playoff_wins = as.numeric(playoff_wins),
         playoff_losses = as.numeric(playoff_losses),
         playoff_win_pct = as.numeric(playoff_win_pct)) %>% 
  mutate(franchise_id = "Hawks")

team_season_data <- function(team_url, franchise_id){
  read_html(team_url) %>% 
  html_nodes("table") %>% 
  .[2] %>% 
  html_table() %>% 
  as.data.frame() %>% 
  slice(2, 5:38) %>% 
  row_to_names(1) %>% 
  clean_names() %>% 
  rename(conference = standing_2) %>% 
  rename(rs_win_pct = percent) %>% 
  rename(playoff_win_pct = percent_2) %>% 
  separate(w_l, into = c("wins", "losses"), sep = "-") %>% 
  separate(w_l_2, into = c("playoff_wins", "playoff_losses"), sep = "-") %>% 
  mutate(lockout = ifelse(season %>% endsWith(" *"), TRUE, FALSE)) %>% 
  mutate(season = ifelse(season %>% endsWith(" *"), 
                         season %>% substr(start = 1, stop = 7),
                         season)) %>% 
  mutate(standing = standing %>% str_extract("\\-*\\d+\\.*\\d*")) %>% 
  rename(conf_standing = standing) %>% 
  mutate(wins = as.numeric(wins),
         losses = as.numeric(losses),
         rs_win_pct = as.numeric(rs_win_pct),
         conf_standing = as.numeric(conf_standing),
         playoff_wins = as.numeric(playoff_wins),
         playoff_losses = as.numeric(playoff_losses),
         playoff_win_pct = as.numeric(playoff_win_pct))%>% 
  mutate(franchise_id = franchise_id)
}

celtics <- team_season_data(
  "https://www.landofbasketball.com/teams/records_boston_celtics.htm",
  "Celtics")

nets <- team_season_data(
  "https://www.landofbasketball.com/teams/records_brooklyn_nets.htm",
  "Nets"
)

# hornets only have 28 rows; started in 1988-89, missing 2002-03 and 2003-04

hornets <- team_season_data(
  "https://www.landofbasketball.com/teams/records_charlotte_hornets.htm",
  "Hornets/Bobcats"
)

bulls <- team_season_data(
  "https://www.landofbasketball.com/teams/records_chicago_bulls.htm",
  "Bulls"
)

cavs <- team_season_data(
  "https://www.landofbasketball.com/teams/records_cleveland_cavaliers.htm",
  "Cavaliers"
)

mavs <- team_season_data(
  "https://www.landofbasketball.com/teams/records_dallas_mavericks.htm",
  "Mavericks"
)

nuggets <- team_season_data(
  "https://www.landofbasketball.com/teams/records_denver_nuggets.htm",
  "Nuggets"
)

pistons <- team_season_data(
  "https://www.landofbasketball.com/teams/records_detroit_pistons.htm",
  "Pistons"
)

warriors <- team_season_data(
  "https://www.landofbasketball.com/teams/records_golden_state_warriors.htm",
  "Warriors"
)

rockets <- team_season_data(
  "https://www.landofbasketball.com/teams/records_houston_rockets.htm",
  "Rockets"
)

pacers <- team_season_data(
  "https://www.landofbasketball.com/teams/records_indiana_pacers.htm",
  "Pacers"
)

clippers <- team_season_data(
  "https://www.landofbasketball.com/teams/records_los_angeles_clippers.htm",
  "Clippers"
)

lakers <- team_season_data(
  "https://www.landofbasketball.com/teams/records_los_angeles_lakers.htm",
  "Lakers"
)

# grizzlies only have 23 rows; started in 1995-96

grizzlies <- team_season_data(
  "https://www.landofbasketball.com/teams/records_memphis_grizzlies.htm",
  "Grizzlies"
)

# heat only have 30 rows; started in 1988-89

heat <- team_season_data(
  "https://www.landofbasketball.com/teams/records_miami_heat.htm",
  "Heat"
)

bucks <- team_season_data(
  "https://www.landofbasketball.com/teams/records_milwaukee_bucks.htm",
  "Bucks"
)

# twolves only have 29 rows; started in 1989-90

twolves <- team_season_data(
  "https://www.landofbasketball.com/teams/records_minnesota_timberwolves.htm",
  "Timberwolves"
)

# pelicans only have 16 rows; started in 2002-03

pelicans <- team_season_data(
  "https://www.landofbasketball.com/teams/records_new_orleans_pelicans.htm",
  "Pelicans/Hornets"
)

knicks <- team_season_data(
  "https://www.landofbasketball.com/teams/records_new_york_knicks.htm",
  "Knicks"
)

thunder <- team_season_data(
  "https://www.landofbasketball.com/teams/records_oklahoma_city_thunder.htm",
  "Thunder/Supersonics"
) %>% 
  mutate(team = gsub("Supersonics", "SuperSonics", team))

# magic only have 29 rows; started in 1989-90

magic <- team_season_data(
  "https://www.landofbasketball.com/teams/records_orlando_magic.htm",
  "Magic"
)

p76ers <- team_season_data(
  "https://www.landofbasketball.com/teams/records_philadelphia_76ers.htm",
  "76ers"
)

suns <- team_season_data(
  "https://www.landofbasketball.com/teams/records_phoenix_suns.htm",
  "Suns"
)

blazers <- team_season_data(
  "https://www.landofbasketball.com/teams/records_portland_trailblazers.htm",
  "Trail Blazers"
)

kings <- team_season_data(
  "https://www.landofbasketball.com/teams/records_sacramento_kings.htm",
  "Kings"
)

spurs <- team_season_data(
  "https://www.landofbasketball.com/teams/records_san_antonio_spurs.htm",
  "Spurs"
)

# raptors only have 23 rows; started in 1995-96

raptors <- team_season_data(
  "https://www.landofbasketball.com/teams/records_toronto_raptors.htm",
  "Raptors"
)

jazz <- team_season_data(
  "https://www.landofbasketball.com/teams/records_utah_jazz.htm",
  "Jazz"
)

wizards <- team_season_data(
  "https://www.landofbasketball.com/teams/records_washington_wizards.htm",
  "Wizards/Bullets"
)

```

```{r join-nba-data, echo=FALSE}

# putting all 30 teams in the same dataframe

nba_team_performance <- bind_rows(blazers,
                              bucks,
                              bulls,
                              cavs,
                              celtics,
                              clippers,
                              grizzlies,
                              hawks,
                              heat,
                              hornets,
                              jazz,
                              kings,
                              knicks,
                              lakers,
                              magic,
                              mavs,
                              nets,
                              nuggets,
                              p76ers,
                              pacers,
                              pelicans,
                              pistons,
                              raptors,
                              rockets,
                              spurs,
                              suns,
                              thunder,
                              twolves,
                              warriors,
                              wizards) %>% 
  mutate(performance = gsub("DNQ", "Did not qualify", performance)) %>% 
  mutate(performance = gsub("Lost East Conf 1st Rd", "Lost 1st Round", performance)) %>% 
  mutate(performance = gsub("Lost West Conf 1st Rd", "Lost 1st Round", performance)) %>% 
  mutate(performance = gsub("Lost East Conf Semis", "Lost Conf Semis", performance)) %>% 
  mutate(performance = gsub("Lost West Conf Semis", "Lost Conf Semis", performance)) %>% 
  mutate(performance = gsub("Lost West Conf Finals", "Lost Conf Finals", performance)) %>% 
  mutate(performance = gsub("Lost East Conf Finals", "Lost Conf Finals", performance))

# checking to make sure I have all 30 franchises (and no more)

# nba_team_performance %>% 
#   group_by(franchise_id) %>% 
#   count()

# split team into two columns, one for team name and one for location

nba_salaries %<>% 
  mutate(location = word(team, start = 1, end = -2)) %>% 
  mutate(mascot = word(team, -1)) %>% 
  mutate(mascot = gsub("Blazers", "Trail Blazers", mascot)) %>% 
  mutate(location = gsub("Portland Trail", "Portland", location))

nba_full <- nba_team_performance %>% 
  left_join(nba_salaries, by = c("team" = "mascot", "season")) %>% 
  mutate(season = as.factor(season)) %>% 
  mutate(conference = as.factor(conference)) %>% 
  mutate(performance = as.factor(performance)) %>% 
  mutate(performance = fct_relevel(performance,
                                   "Did not qualify",
                                   "Lost 1st Round",
                                   "Lost Conf Semis",
                                   "Lost Conf Finals",
                                   "Lost NBA Finals",
                                   "NBA Champions")) %>% 
  mutate(franchise_id = as.factor(franchise_id))

```

```{r plot-nba-data, echo=FALSE}

ggplot(nba_full, 
       aes(season, team_salary / 1000000, color = performance)) +
  geom_point(alpha = .7, na.rm = TRUE) +
  scale_color_manual(breaks = c("Did not qualify",
                                "Lost 1st Round",
                                "Lost Conf Semis",
                                "Lost Conf Finals",
                                "Lost NBA Finals",
                                "NBA Champions"),
                     values = c("black",
                                "purple",
                                "red",
                                "red",
                                "green",
                                "green")) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 1,
                                   hjust = 0)) +
  labs(title = "NBA Team Payroll and Playoff Result by Season",
       color = "Playoff Result") +
  xlab("Season") +
  ylab("Team Payroll (millions)")

nba_full %>% 
  ggplot(aes(team_salary / 1000000, rs_win_pct)) +
  geom_point(na.rm = TRUE) +
  facet_wrap(~ season, scales = "free_x") +
  theme_classic() +
  labs(title = "NBA Team Payroll and Regular Season Win Percentage",
       subtitle = "Observe changes over time",
       x = "Payroll (millions)",
       y = "Regular Season Win Percentage") +
  geom_smooth(method = "lm", se = FALSE)

# can add performance to this plot really easily by adding it as the color,
# copying the specs from the plot above

ggsave("nba_payroll_winpct_plot_free_x.png")

```

```{r nba-and-mlb-plots-with-colored-performance, echo=FALSE}

mlb_full %>% 
  ungroup() %>% 
  ggplot(aes(payroll / 1000000, 
             round(rs_win_pct, digits = 2),
             color = div_win)) +
  geom_point() +
  facet_wrap(~year, scales = "free_x") +
  labs(title = "MLB Team Payroll, Regular Season Wins, and Division Titles",
       subtitle = "Money may buy wins, but not necessarily a division title",
       x = "Payroll (in millions)",
       y = "Regular Season Win Percentage") +
  theme_classic() +
  scale_x_continuous(breaks = c(0, 100, 200)) +
  scale_color_manual(name = "Won Division",
                     breaks = c("Y", "N"),
                     labels = c("Yes", "No"),
                     values = c("black", "red")) +
  geom_smooth(method = "lm", se = FALSE)

ggsave("mlb_payroll_winpct_performance_plot_free_x.png")

nba_full %>% 
  ggplot(aes(team_salary / 1000000, rs_win_pct, color = performance)) +
  geom_point(na.rm = TRUE) +
  facet_wrap(~ season, scales = "free_x") +
  theme_classic() +
  labs(title = "NBA Team Payroll, Regular Season Wins, and Playoff Results",
       subtitle = "Money positively associated with team performance",
       x = "Payroll (in millions)",
       y = "Regular Season Win Percentage") +
  scale_color_manual(name = "Playoff Performance",
                     breaks = c("Did not qualify",
                                "Lost 1st Round",
                                "Lost Conf Semis",
                                "Lost Conf Finals",
                                "Lost NBA Finals",
                                "NBA Champions"),
                     values = c("black",
                                "dark red",
                                "pink",
                                "red",
                                "light blue",
                                "green")) +
  geom_smooth(method = "lm", se = FALSE)

ggsave("nba_payroll_winpct_performance_plot_free_x.png")

```

Side-by-side comparison:

```{r side-by-side, echo=FALSE}

mlb_1 <- mlb_full %>% 
  ggplot(aes(payroll / 1000000, 
             round(rs_win_pct, digits = 2))) +
  geom_point() +
  facet_wrap(~year) +
  labs(title = "MLB Team Payroll and Regular Season Win Percentage",
       subtitle = "See a positive correlation emerging over time",
       x = "Payroll (millions)",
       y = "Regular Season Win Percentage") +
  theme_classic() +
  scale_x_continuous(breaks = c(0, 100, 200)) 

nba_1 <- nba_full %>% 
  ggplot(aes(team_salary / 1000000, rs_win_pct)) +
  geom_point(na.rm = TRUE) +
  facet_wrap(~ season) +
  theme_classic() +
  labs(title = "NBA Team Payroll and Regular Season Win Percentage",
       subtitle = "Positive correlation observable in some years",
       x = "Payroll (millions)",
       y = "Regular Season Win Percentage")

grid.arrange(mlb_1, nba_1, ncol = 2)

mlb_2 <- mlb_full %>% 
  ggplot(aes(payroll / 1000000, 
             round(rs_win_pct, digits = 2),
             color = div_win)) +
  geom_point() +
  facet_wrap(~year, scales = "free_x") +
  labs(title = "MLB Team Payroll, Regular Season Wins, and Division Titles",
       subtitle = "Money may buy wins, but not necessarily a division title",
       x = "Payroll (in millions)",
       y = "Regular Season Win Percentage") +
  theme_classic() +
  scale_x_continuous(breaks = c(0, 100, 200)) +
  scale_color_manual(name = "Won Division",
                     breaks = c("Y", "N"),
                     labels = c("Yes", "No"),
                     values = c("black", "red"))

nba_2 <- nba_full %>% 
  ggplot(aes(team_salary / 1000000, rs_win_pct, color = performance)) +
  geom_point(na.rm = TRUE) +
  facet_wrap(~ season, scales = "free_x") +
  theme_classic() +
  labs(title = "NBA Team Payroll, Regular Season Wins, and Playoff Results",
       subtitle = "Money seems to have limited effect on team performance",
       x = "Payroll (in millions)",
       y = "Regular Season Win Percentage") +
  scale_color_manual(name = "Playoff Performance",
                     breaks = c("Did not qualify",
                                "Lost 1st Round",
                                "Lost Conf Semis",
                                "Lost Conf Finals",
                                "Lost NBA Finals",
                                "NBA Champions"),
                     values = c("black",
                                "dark red",
                                "pink",
                                "red",
                                "light blue",
                                "green"))

grid.arrange(mlb_2, nba_2, ncol = 2)

mlb_full %>% 
  summarize(cor = cor(rs_win_pct, payroll))

```

Could scrape NHL data from here if so inclined:
https://en.wikipedia.org/wiki/List_of_team_payrolls_in_the_NHL

